<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhiyun.dao.impl.ProdBomPlmDaoImpl">
    <select id="searchForProduct" resultType="com.zhiyun.dto.ProductStorePlmDto" parameterType="map">
        SELECT
        product_store_plm.id id,
        product_store_plm.prod_name prodName,
        product_store_plm.prod_no prodNo
        # product_mid_plm.id midProductId,
        # product_mid_plm.mid_prod_name midProdName,
        # product_mid_plm.mid_prod_no midProdNo
        FROM
        product_store_plm
        # LEFT JOIN product_mid_plm ON product_store_plm.prod_no = product_mid_plm.prod_no
        # AND product_mid_plm.deleted = 'F'
        WHERE
        product_store_plm.company_id = #{companyId}
        AND product_store_plm.deleted = 'F'
        AND product_store_plm.prod_name like concat('%',#{productName},'%')
        <!--<if test="bomCode!=null and bomCode!= '' ">-->
        <!--OR product_mid_plm.mid_prod_no = #{bomCode}-->
        <!--</if>-->
    </select>
    <!--<resultMap id="searchMap" type="com.zhiyun.dto.ProductStorePlmDto">-->
    <!--<id javaType="long" column="id" property="id"/>-->
    <!--<result column="prodName" property="prodName"/>-->
    <!--<result column="prodNo" property="prodNo"/>-->
    <!--<collection property="midProducts" ofType="com.zhiyun.entity.ProductMidPlm" javaType="ArrayList">-->
    <!--<id column="midProductId" javaType="long" property="id"/>-->
    <!--<result column="midProdName" property="midProdName"/>-->
    <!--<result column="midProdNo" property="midProdNo"/>-->
    <!--</collection>-->
    <!--</resultMap>-->

    <select id="findBomByPno" parameterType="map" resultType="com.zhiyun.dto.ProdBomPlmDto">
        SELECT prod_bom_plm.bom_no         AS bomNo,
               prod_bom_plm.versions,
               prod_bom_plm.make_emp       AS makeEmp,
               prod_bom_plm.bom_status     AS bomStatus,
               prod_bom_plm.`status`,
               prod_bom_plm.make_date      AS makeDate,
               voucher_main_oa.is_finished AS voucherStatus,
               product_store_plm.id        AS productId,
               product_store_plm.prod_no   AS productNo,
               product_store_plm.prod_name AS productName
        FROM prod_bom_plm
                 left JOIN voucher_main_oa ON voucher_main_oa.voucher_no = prod_bom_plm.voucher_no
                                                  AND voucher_main_oa.deleted = 'F'
                 INNER JOIN product_store_plm ON prod_bom_plm.prod_no = product_store_plm.prod_no
                                                     AND product_store_plm.deleted = 'F'
        WHERE prod_bom_plm.deleted = 'F'
          AND prod_bom_plm.company_id = #{companyId}
          and prod_bom_plm.prod_no = #{productNo}
    </select>
    <select id="findBomByMpno" parameterType="map" resultType="com.zhiyun.dto.ProdBomPlmDto">
        SELECT prod_bom_plm.bom_no     AS  bomNo,
               prod_bom_plm.versions,
               prod_bom_plm.make_emp   AS  makeEmp,
               prod_bom_plm.bom_status AS  bomStatus,
               prod_bom_plm.`status`,
               prod_bom_plm.make_date  AS  makeDate,
               voucher_main_oa.is_finished voucherStatus
        FROM prod_bom_plm
                 LEFT JOIN voucher_main_oa ON voucher_main_oa.voucher_no = prod_bom_plm.voucher_no
                                                  AND voucher_main_oa.deleted = 'F'
                                                  AND prod_bom_plm.company_id = #{companyId}
                                                  and prod_bom_plm.mid_prod_no = #{midProductNo}
    </select>

    <update id="updateBom" parameterType="map">
        update prod_bom_plm
        set voucher_no = #{vocherNo}
        where deleted = 'F'
          and bom_no = #{bomCode}
          and company_id = #{companyId}
    </update>
    <update id="startOrStopBom" parameterType="map">
        update prod_bom_plm
        set bom_status = #{bomStatus}
        where deleted = 'F'
          and company_id = #{companyId}
          and bom_no = #{bomCode}
    </update>
    <select id="selectBeforeUpdate" parameterType="map" resultType="com.zhiyun.entity.ProdBomPlm">
        select bom_status bomStatus
        from prod_bom_plm
        where deleted = 'F'
          and company_id = #{companyId}
          and bom_no = #{bomCode}

    </select>
    <select id="searchForCompnent" resultMap="searchComponentMap" parameterType="map">
        SELECT
        product_store_plm.id id,
        product_store_plm.prod_name prodName,
        product_store_plm.prod_no prodNo,
        product_mid_plm.id midProductId,
        product_mid_plm.mid_prod_name midProdName,
        product_mid_plm.mid_prod_no midProdNo
        FROM
        product_store_plm
        LEFT JOIN product_mid_plm ON product_store_plm.prod_no = product_mid_plm.prod_no
        AND product_mid_plm.deleted = 'F'
        WHERE
        product_store_plm.company_id = #{companyId}
        AND product_store_plm.deleted = 'F'
        AND product_store_plm.prod_name=#{productName}
        <if test="bomCode!=null and bomCode!= '' ">
            OR product_mid_plm.mid_prod_no = #{bomCode}
        </if>
    </select>
    <resultMap id="searchComponentMap" type="com.zhiyun.dto.ProductStorePlmDto">
        <id javaType="long" column="id" property="id"/>
        <result column="prodName" property="prodName"/>
        <result column="prodNo" property="prodNo"/>
        <collection property="midProducts" ofType="com.zhiyun.entity.ProductMidPlm" javaType="ArrayList">
            <id column="midProductId" javaType="long" property="id"/>
            <result column="midProdName" property="midProdName"/>
            <result column="midProdNo" property="midProdNo"/>
        </collection>
    </resultMap>


    <select id="optionBomCodeAndProdName" parameterType="map" resultType="com.zhiyun.dto.MattersStoreDto">
        SELECT matters_store_ios.id, matters_store_ios.matters_no mattersNo, matters_store_ios.matters_name mattersName
        FROM matters_store_ios
        WHERE deleted = 'F'
          and is_midprod != 2
          AND company_id = #{companyId}
    </select>


    <select id="findAllMidProductByPno" parameterType="map" resultType="com.zhiyun.dto.ProductMidPlmDto">
        SELECT product_mid_plm.id, product_mid_plm.mid_prod_no midProdNo, product_mid_plm.mid_prod_name midProdName, product_mid_plm.amount
        FROM product_mid_plm
        WHERE deleted = 'F'
          AND company_id = #{companyId}
          AND parent_no = #{productNo}
    </select>

    <select id="findAllMattersFroProduct" parameterType="map" resultType="com.zhiyun.dto.MattersStoreDto">
        SELECT prod_bom_detail_plm.id,
               prod_bom_detail_plm.amount,
               prod_bom_detail_plm.plm_desc                                                                     plmDesc,
               backMatter.MATTERS_NO                                                                            backUpMatterNo,
               CONCAT(backMatter.MATTERS_NO, '/', backMatter.MATTERS_NAME)                                      backMattersInfo,
               CONCAT(matters_store_ios.MATTERS_NO, '/', matters_store_ios.MATTERS_NAME)                        mattersInfo,
               CONCAT(matters_store_ios.NORMS, '/', matters_store_ios.PARAM, '/', matters_store_ios.MODEL_DESC) allInfo,
               matters_store_ios.versions,
               matters_store_ios.unit,
               matters_store_ios.matters_no                                                                     mattersNo,
               matters_store_ios.is_midprod                                                                     isMidprod
        FROM prod_bom_detail_plm
                 INNER JOIN matters_store_ios ON prod_bom_detail_plm.matters_no = matters_store_ios.matters_no
                                                     AND matters_store_ios.deleted = 'F'
                 INNER JOIN matters_store_ios AS backMatter ON prod_bom_detail_plm.backup_matter = backMatter.matters_no
                                                                   AND matters_store_ios.deleted = 'F'
        WHERE prod_bom_detail_plm.company_id = #{companyId}
          AND prod_bom_detail_plm.deleted = 'F'
          AND prod_bom_detail_plm.parent_no = #{productNo}
    </select>

    <select id="findAllMattersAndComponet" parameterType="map" resultType="com.zhiyun.dto.MattersStoreDto">
        SELECT prod_bom_detail_plm.id,
               prod_bom_detail_plm.amount,
               prod_bom_detail_plm.plm_desc                                                                     plmDesc,
               backMatter.MATTERS_NO                                                                            backUpMatterNo,
               CONCAT(backMatter.MATTERS_NO, '/', backMatter.MATTERS_NAME)                                      backMattersInfo,
               CONCAT(matters_store_ios.MATTERS_NO, '/', matters_store_ios.MATTERS_NAME)                        mattersInfo,
               CONCAT(matters_store_ios.NORMS, '/', matters_store_ios.PARAM, '/', matters_store_ios.MODEL_DESC) allInfo,
               matters_store_ios.versions,
               matters_store_ios.unit,
               matters_store_ios.is_midprod                                                                     isMidprod,
               matters_store_ios.matters_no                                                                     mattersNo
        FROM prod_bom_detail_plm
                 INNER JOIN matters_store_ios ON prod_bom_detail_plm.matters_no = matters_store_ios.matters_no
                                                     AND matters_store_ios.deleted = 'F' and matters_store_ios.company_id = #{companyId}
                 INNER JOIN matters_store_ios AS backMatter ON prod_bom_detail_plm.backup_matter = backMatter.matters_no
                                                                   AND backMatter.deleted = 'F'
                                                                   and backMatter.company_id = #{companyId}
        WHERE prod_bom_detail_plm.company_id = #{companyId}
          AND prod_bom_detail_plm.deleted = 'F'
          and matters_store_ios.is_midprod != 2
          and backMatter.is_midprod != 2
          AND prod_bom_detail_plm.parent_no = #{matterNo}
    </select>
    <select id="SearchBeforeAddMatters" parameterType="map" resultType="com.zhiyun.dto.MattersStoreDto">
        SELECT s.ID                                             id,
               CONCAT(s.MATTERS_NO, '/', s.MATTERS_NAME)        mattersInfo,
               s.MATTERS_NO                                     mattersNo,
               CONCAT(s.NORMS, '/', s.PARAM, '/', s.MODEL_DESC) allInfo,
               s.UNIT                                           unit,
               s.WEIGHT                                         weight,
               t.type_name                                      typeName
        FROM MATTERS_STORE_IOS s
                 LEFT JOIN matters_type_ios t ON s.TYPE_ID = t.id
                                                     AND t.deleted = 'F'
        WHERE s.deleted = 'F'
          and s.is_midprod != 2
          AND s.company_id = #{companyId}
          AND s.matters_no != #{parentNo}
          AND (s.matters_no LIKE CONCAT('%', #{codeOrName}, '%') OR s.matters_name LIKE CONCAT('%', #{codeOrName}, '%'))

    </select>

    <select id="findMidProduct" parameterType="map" resultType="com.zhiyun.dto.ProductMidPlmDto">
        SELECT product_mid_plm.id, product_mid_plm.mid_prod_no midProdNo, product_mid_plm.mid_prod_name midProdName
        FROM product_mid_plm
        WHERE deleted = 'F'
          AND company_id = #{companyId}
          AND parent_no = #{parentNo}
    </select>

    <select id="findCommonBomByMatterName" parameterType="map" resultType="com.zhiyun.dto.ProdBomPlmDto">
        SELECT prod_bom_plm.bom_no         AS bomNo,
               prod_bom_plm.versions,
               prod_bom_plm.make_emp       AS makeEmp,
               prod_bom_plm.bom_status     AS bomStatus,
               prod_bom_plm.`status`,
               prod_bom_plm.make_date      AS makeDate,
               voucher_main_oa.is_finished AS voucherStatus,
               matters_store_ios.id,
               matters_store_ios.matters_no   mattersNo,
               matters_store_ios.matters_name mattersName
        FROM prod_bom_plm
                 LEFT JOIN voucher_main_oa ON voucher_main_oa.voucher_no = prod_bom_plm.voucher_no
                                                  AND voucher_main_oa.deleted = 'F'
                                                  AND voucher_main_oa.company_id = #{companyId}
                 INNER JOIN matters_store_ios ON prod_bom_plm.prod_no = matters_store_ios.matters_no
                                                     AND matters_store_ios.deleted = 'F'
                                                     AND matters_store_ios.company_id = #{companyId}
                                                     and matters_store_ios.is_midprod = 1
        WHERE prod_bom_plm.deleted = 'F'
          AND prod_bom_plm.company_id = #{companyId}
          AND matters_store_ios.matters_name LIKE CONCAT('%', #{matterName}, '%')
    </select>

    <select id="findCommonBomByBomCode" parameterType="map" resultType="com.zhiyun.dto.ProdBomPlmDto">
        SELECT prod_bom_plm.bom_no         AS bomNo,
               prod_bom_plm.versions,
               prod_bom_plm.make_emp       AS makeEmp,
               prod_bom_plm.bom_status     AS bomStatus,
               prod_bom_plm.`status`,
               prod_bom_plm.make_date      AS makeDate,
               voucher_main_oa.is_finished AS voucherStatus,
               product_store_plm.id        AS productId,
               product_store_plm.prod_no   AS productNo,
               product_store_plm.prod_name AS productName
        FROM prod_bom_plm
                 LEFT JOIN voucher_main_oa ON voucher_main_oa.voucher_no = prod_bom_plm.voucher_no
                                                  AND voucher_main_oa.deleted = 'F'
                 INNER JOIN product_store_plm ON prod_bom_plm.prod_no = product_store_plm.prod_no
                                                     AND product_store_plm.deleted = 'F'
        WHERE prod_bom_plm.deleted = 'F'
          AND prod_bom_plm.company_id = #{companyId}
          AND prod_bom_plm.bom_no = #{bomCode}
    </select>

    <select id="findCommonBomByProdNo" resultType="com.zhiyun.dto.ProdBomPlmDto" parameterType="map">
        SELECT prod_bom_plm.bom_no         AS bomNo,
               prod_bom_plm.versions,
               prod_bom_plm.make_emp       AS makeEmp,
               prod_bom_plm.bom_status     AS bomStatus,
               prod_bom_plm.`status`,
               prod_bom_plm.make_date      AS makeDate,
               voucher_main_oa.is_finished AS voucherStatus,
               matters_store_ios.id,
               matters_store_ios.matters_no   mattersNo,
               matters_store_ios.matters_name mattersName
        FROM prod_bom_plm
                 LEFT JOIN voucher_main_oa ON voucher_main_oa.voucher_no = prod_bom_plm.voucher_no
                                                  AND voucher_main_oa.deleted = 'F'
                                                  AND voucher_main_oa.company_id = #{companyId}
                 INNER JOIN matters_store_ios ON prod_bom_plm.prod_no = matters_store_ios.matters_no
                                                     AND matters_store_ios.deleted = 'F'
                                                     AND matters_store_ios.company_id = #{companyId}
        WHERE prod_bom_plm.deleted = 'F'
          AND prod_bom_plm.company_id = #{companyId}
          AND prod_bom_plm.prod_no = #{prodNo}
    </select>

    <select id="optionComponent" parameterType="map" resultType="com.zhiyun.dto.MattersStoreDto">
        SELECT matters_store_ios.id, matters_store_ios.matters_no mattersNo, matters_store_ios.matters_name mattersName
        FROM matters_store_ios
        WHERE deleted = 'F'
          and is_midprod = 1
          AND company_id = #{companyId}
    </select>


    <select id="findCommonBomByMatterNo" resultType="com.zhiyun.dto.ProdBomPlmDto" parameterType="map">
        SELECT prod_bom_plm.bom_no         AS bomNo,
               prod_bom_plm.versions,
               prod_bom_plm.make_emp       AS makeEmp,
               prod_bom_plm.bom_status     AS bomStatus,
               prod_bom_plm.`status`,
               prod_bom_plm.make_date      AS makeDate,
               voucher_main_oa.is_finished AS voucherStatus,
               matters_store_ios.id,
               matters_store_ios.matters_no   mattersNo,
               matters_store_ios.matters_name mattersName
        FROM prod_bom_plm
                 LEFT JOIN voucher_main_oa ON voucher_main_oa.voucher_no = prod_bom_plm.voucher_no
                                                  AND voucher_main_oa.deleted = 'F'
                                                  AND voucher_main_oa.company_id = #{companyId}
                 INNER JOIN matters_store_ios ON prod_bom_plm.prod_no = matters_store_ios.matters_no
                                                     AND matters_store_ios.deleted = 'F'
                                                     AND matters_store_ios.company_id = #{companyId}
        WHERE prod_bom_plm.deleted = 'F'
          AND prod_bom_plm.company_id = #{companyId}
          AND prod_bom_plm.prod_no = #{matterNo}
    </select>

    <!-- 分页查询（计数） -->
    <select id="customPage_count" parameterType="map" resultType="int">
        SELECT count(*)
        FROM
        prod_bom_plm
        INNER JOIN voucher_main_oa ON prod_bom_plm.voucher_no = voucher_main_oa.voucher_no
        AND voucher_main_oa.company_id = #{entity.companyId}
        AND voucher_main_oa.deleted = 'F'
        LEFT JOIN matters_store_ios ON prod_bom_plm.prod_no = matters_store_ios.matters_no
        AND matters_store_ios.company_id = #{entity.companyId}
        AND matters_store_ios.deleted = 'F'
        LEFT JOIN product_store_plm ON prod_bom_plm.prod_no = product_store_plm.prod_no
        AND product_store_plm.company_id = #{entity.companyId}
        AND product_store_plm.deleted = 'F'
        WHERE
        prod_bom_plm.deleted = 'F'
        AND prod_bom_plm.company_id = #{entity.companyId}
        <if test="entity.voucherNo != null and entity.voucherNo != ''">
            AND prod_bom_plm.voucher_no = #{entity.voucherNo,jdbcType=VARCHAR}
        </if>
        <if test="entity.bomNo != null and entity.bomNo != ''">
            AND prod_bom_plm.bom_no = #{entity.bomNo,jdbcType=VARCHAR}
        </if>
        <if test="entity.prodNo != null and entity.prodNo != ''">
            AND prod_bom_plm.prod_no = #{entity.prodNo,jdbcType=VARCHAR}
        </if>
        <if test="entity.mattersNo != null and entity.mattersNo != ''">
            OR prod_bom_plm.prod_no = #{entity.mattersNo,jdbcType=VARCHAR}
        </if>
    </select>

    <!-- 分页查询（数据） -->
    <select id="customPage_datas" parameterType="map" resultType="com.zhiyun.dto.ProdBomPlmDto">
        <include refid="mybatis.pageStartSQL"/>
        SELECT
        prod_bom_plm.id,
        prod_bom_plm.voucher_no voucherNo,
        prod_bom_plm.bom_no bomNo,
        prod_bom_plm.make_date makeDate,
        prod_bom_plm.make_emp makeEmp,
        voucher_main_oa.is_finished voucherStatus,
        matters_store_ios.matters_name mattersName,
        product_store_plm.prod_name productName
        FROM
        prod_bom_plm
        INNER JOIN voucher_main_oa ON prod_bom_plm.voucher_no = voucher_main_oa.voucher_no
        AND voucher_main_oa.company_id = #{entity.companyId}
        AND voucher_main_oa.deleted = 'F'
        LEFT JOIN matters_store_ios ON prod_bom_plm.prod_no = matters_store_ios.matters_no
        AND matters_store_ios.company_id = #{entity.companyId}
        AND matters_store_ios.deleted = 'F'
        LEFT JOIN product_store_plm ON prod_bom_plm.prod_no = product_store_plm.prod_no
        AND product_store_plm.company_id = #{entity.companyId}
        AND product_store_plm.deleted = 'F'
        WHERE
        prod_bom_plm.deleted = 'F'
        AND prod_bom_plm.company_id = #{entity.companyId}
        <if test="entity.voucherNo != null and entity.voucherNo != ''">
            AND prod_bom_plm.voucher_no = #{entity.voucherNo,jdbcType=VARCHAR}
        </if>
        <if test="entity.bomNo != null and entity.bomNo != ''">
            AND prod_bom_plm.bom_no = #{entity.bomNo,jdbcType=VARCHAR}
        </if>
        <if test="entity.prodNo != null and entity.prodNo != ''">
            AND prod_bom_plm.prod_no = #{entity.prodNo,jdbcType=VARCHAR}
        </if>
        <if test="entity.mattersNo != null and entity.mattersNo != ''">
            OR prod_bom_plm.prod_no = #{entity.mattersNo,jdbcType=VARCHAR}
        </if>
        <include refid="mybatis.pageEndSQL"/>
    </select>
    <!--resultType="com.zhiyun.dto.FormulaDto"-->
    <select id="findBomByPnoForFormula" parameterType="map" resultMap="formulaMap">
        SELECT prod_bom_plm.bom_no                                                 AS bomNo,
               prod_bom_plm.versions,
               concat(product_store_plm.prod_no, '/', product_store_plm.prod_name) AS prodName,
               prod_bom_plm.bom_status                                                bomStatus,
               formula_bom_plm.id                                                     formulaId,
               formula_bom_plm.formula_no                                             formulaNo,
               formula_bom_plm.formula_name                                           formulaName,
               formula_bom_plm.matter_no                                              matterNo,
               formula_bom_plm.amount,
               formula_bom_plm.unit,
               formula_bom_plm.norms
        FROM prod_bom_plm
                 INNER JOIN product_store_plm ON product_store_plm.prod_no = prod_bom_plm.prod_no
                                                     AND product_store_plm.deleted = 'F'
                 LEFT JOIN formula_bom_plm ON formula_bom_plm.bom_no = prod_bom_plm.bom_no
                                                  AND formula_bom_plm.deleted = 'F'
        WHERE prod_bom_plm.deleted = 'F'
          AND prod_bom_plm.company_id = #{companyId}
          AND prod_bom_plm.prod_no = #{productNo}
    </select>
    <resultMap id="formulaMap" type="com.zhiyun.dto.FormulaDto">
        <result column="bomNo" property="bomNo"/>
        <result column="versions" property="versions"/>
        <result column="prodName" property="productName"/>
        <result column="bomStatus" property="bomStatus"/>
        <collection property="formulaBomPlms" ofType="com.zhiyun.entity.FormulaBomPlm" javaType="ArrayList">
            <id column="formulaId" javaType="long" property="id"/>
            <result column="formulaNo" property="formulaNo"/>
            <result column="formulaName" property="formulaName"/>
            <result column="matterNo" property="matterNo"/>
            <result column="amount" property="amount"/>
            <result column="unit" property="unit"/>
            <result column="norms" property="norms"/>
        </collection>
    </resultMap>


    <select id="uniqueBom" parameterType="map" resultType="com.zhiyun.entity.ProdBomPlm">
        SELECT prod_bom_plm.id
        FROM prod_bom_plm
        WHERE deleted = 'F'
          AND company_id = #{companyId}
          AND bom_no = #{bomNo}
    </select>
</mapper>
